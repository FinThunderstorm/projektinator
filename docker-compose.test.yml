version: "3.8"

services:
  testapp:
    build:
      context: ./
      dockerfile: ./dev.Dockerfile
    image: projektinator-test-dev
    container_name: lukuvinkkikirjasto-test-dev
    command: poetry run invoke coverage-report
    depends_on:
      - testdb
    ports:
      - 5005:5000
    environment:
      - MODE=test
      - SECRET=test
      - DATABASE_URI=postgresql://test:test@projektinator-test-db:5432/projektinator-test
    volumes:
      - ./:/projektinator

  testdb:
    image: postgres:latest
    container_name: lukuvinkkikirjasto-test-db
    environment:
      - POSTGRES_USER=test
      - POSTGRES_DB=lukuvinkkikirjasto-test
      - POSTGRES_PASSWORD=test
      - POSTGRES_PORT=5432
    volumes:
      - ./database_structure.sql:/docker-entrypoint-initdb.d/02-database_structure.sql
